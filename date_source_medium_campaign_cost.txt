WITH
segmentation_basic AS
  (
  SELECT  
  *,
  CASE
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"flight")=false AND source="yandex" AND medium="cpc" AND REGEXP_CONTAINS(LOWER(campaign),"smart|banner|display|flight|rsy|sb|msk2|retarg|brand|бренд|vvk|network|rsy|рся|срм")=false AND REGEXP_CONTAINS(LOWER(campaign),"ios|andr|app|uac")=false AND REGEXP_CONTAINS(LOWER(campaign),"video")=false THEN "yandex_direct_web_non_brand"
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"flight")=false AND source="yandex" AND medium="cpc" AND REGEXP_CONTAINS(LOWER(campaign),"brand|бренд") AND REGEXP_CONTAINS(LOWER(campaign),"ios|andr|app|uac|rsy")=false THEN "yandex_direct_web_brand"
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"flight")=false AND source="yandex" AND medium="cpc" AND REGEXP_CONTAINS(LOWER(campaign),"рся|rsy|network|retarget|smart") AND REGEXP_CONTAINS(LOWER(campaign),"ios|andr|app|uac|brand|бренд|src")=false THEN "yandex_direct_web_rsy"


  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"flight")=false AND source="google" AND medium="cpc" AND REGEXP_CONTAINS(LOWER(campaign),"smart|banner|display|rsy|sb|msk2|retarg|brand|бренд|vvk|network|rsy|рся|срм")=false AND REGEXP_CONTAINS(LOWER(campaign),"ios|andr|uac|kms|app")=false  THEN "google_ads_web_non_brand"
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"flight")=false AND source="google" AND medium="cpc" AND REGEXP_CONTAINS(LOWER(campaign),"brand|бренд") AND REGEXP_CONTAINS(LOWER(campaign),"ios|andr|app|uac|kms")=false THEN "google_ads_web_brand"
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"flight")=false AND source="google" AND medium="cpc" AND REGEXP_CONTAINS(LOWER(campaign),"кмс|kms|network|retarget") AND REGEXP_CONTAINS(LOWER(campaign),"ios|andr|app|uac|src")=false THEN "google_ads_web_kms"


  WHEN REGEXP_CONTAINS(LOWER(campaign),"ios|android|app|uac") AND REGEXP_CONTAINS(LOWER(campaign),"flight")=false AND source IN ("yandex", "yabs.yandex.ru") THEN "yandex_direct_app"


  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"flight")=false AND source="google" AND REGEXP_CONTAINS(LOWER(campaign),"ios|andr|app|uac") THEN "google_ads_uac"


  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"flight")=false AND REGEXP_CONTAINS(LOWER(source),"target.my.com|mycom|mytarget") AND REGEXP_CONTAINS(LOWER(campaign),"seller")=false AND REGEXP_CONTAINS(LOWER(campaign_info),"flight")=false THEN "mytarget"
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"flight")=false AND source IN("vk_ads","vk apps") AND REGEXP_CONTAINS(LOWER(campaign_info),"алиса")=false AND  REGEXP_CONTAINS(LOWER(campaign),"алиса")=false THEN "vk_ads"
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"flight")=false AND (REGEXP_CONTAINS(campaign_info,"smm_vk") OR REGEXP_CONTAINS(campaign,"smm_vk")) AND (REGEXP_CONTAINS(LOWER(campaign_info),"алиса") OR REGEXP_CONTAINS(LOWER(campaign),"алиса")) THEN "smm_vk"
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"flight")=false AND source="apple_search_ads" AND REGEXP_CONTAINS(LOWER(campaign),"brand|бренд")  THEN "asa_brand"
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"flight")=false AND source="apple_search_ads" AND REGEXP_CONTAINS(LOWER(campaign),"brand|бренд")=false THEN "asa_non_brand"
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"flight")=false AND source="tiktok" THEN "tiktok_app"
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"flight")=false AND REGEXP_CONTAINS(LOWER(source),"facebook|23847044487210398")  THEN "facebook_ads"


  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"flight") OR REGEXP_CONTAINS(LOWER(campaign),"flight") THEN "regular_online"
  ELSE "other"


  END AS segment,
  CAST(IF((REGEXP_CONTAINS(LOWER(campaign),"ретарг|ремарк|retarg|remark|exist|rem") AND REGEXP_CONTAINS(LOWER(campaign),"premium")=false) OR (REGEXP_CONTAINS(LOWER(campaign_info),"ретарг|ремарк|retarg|remark|exist|rem") AND REGEXP_CONTAINS(LOWER(campaign_info),"premium")=false) OR (source="yandex" AND medium="cpc" AND REGEXP_CONTAINS(LOWER(campaign),"smart|retargering|ретаргетинг|rlsa|рлса")),1,0) AS INT64) as is_retargeting_campaign,


  FROM `funnel-flowwow.BUSINESS_DM.cm_date_source_medium_campaign_cost`


  WHERE REGEXP_CONTAINS(LOWER(campaign),"seller|courier|продав|курьер|бизнес")=false AND REGEXP_CONTAINS(LOWER(campaign_info),"seller|courier|продав|курьер|бизнес")=false
  ),
channels AS
  (
  SELECT date, source, medium, campaign, cost, clicks, impressions, segment, campaign_info, is_retargeting_campaign,
  CASE
  WHEN segment IN ("yandex_direct_web_non_brand","yandex_direct_web_brand","yandex_direct_web_rsy") AND is_retargeting_campaign!=1 THEN "yandex_direct_web"
  WHEN segment IN ("google_ads_web_non_brand","google_ads_web_brand","google_ads_web_kms") AND is_retargeting_campaign!=1 THEN "google_ads_web"
  WHEN segment IN ("asa_brand", "asa_non_brand") AND is_retargeting_campaign!=1 THEN "apple_search_ads"
  WHEN segment IN ("special_offline","regular_online", "special_online") AND is_retargeting_campaign!=1 THEN "mediaflights"
  WHEN segment IN ("smm_vk") AND is_retargeting_campaign!=1 THEN "smm"
  WHEN segment NOT IN ("yandex_direct_web_non_brand","yandex_direct_web_brand","yandex_direct_web_rsy","google_ads_web_non_brand","google_ads_web_brand","google_ads_web_kms","asa_non_brand", "asa_brand","special_offline","regular_online", "special_online","smm_vk") AND is_retargeting_campaign!=1 THEN segment
  WHEN is_retargeting_campaign=1 THEN "retargeting"
  END AS channel
  FROM segmentation_basic
  ),
subdivisions AS  
  (
  SELECT date, source, medium, campaign, cost, clicks, impressions, segment, channel, campaign_info, is_retargeting_campaign,
  CASE
  WHEN segment IN ("yandex_direct_web_non_brand","yandex_direct_web_brand","yandex_direct_web_rsy") OR segment IN ("google_ads_web_non_brand","google_ads_web_brand","google_ads_web_kms") THEN "paid_web"
  WHEN segment IN ("smm_vk","smm_telegram","serm","offline_merch","pr","pr_telegram","influencers","smm_instagram","creatives","regular_online","special_offline","special_online","dzen_client","ya_promo") THEN "brand"
  WHEN channel ="other" THEN "other"
  ELSE "paid_apps"
  END AS subdivision
  FROM channels
  ),
cities_categories_subcategories_id AS
  (
  SELECT date, source, medium, campaign, cost, clicks, impressions, segment, channel, subdivision, is_retargeting_campaign,


  CASE


  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"cityid") THEN REGEXP_EXTRACT(campaign_info,r"cityid-([0-9]+)")
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"city") AND REGEXP_CONTAINS(LOWER(campaign_info),"cityid")=false THEN REGEXP_EXTRACT(campaign_info,r"city([0-9]+)")
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"nocity")
  THEN "nocity"


  END AS city_id,


  CASE


  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"catid-") THEN REGEXP_EXTRACT(campaign_info,r"catid-([0-9]+)")
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"cat-")  THEN REGEXP_EXTRACT(campaign_info,r"cat-([0-9]+)")
  ELSE "nocategory"
  END AS category_id,


  CASE


  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"subcatid-") THEN REGEXP_EXTRACT(campaign_info,r"subcatid-([0-9]+)")
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"subcat-")  THEN REGEXP_EXTRACT(campaign_info,r"subcat-([0-9]+)")
  WHEN REGEXP_CONTAINS(LOWER(campaign_info),"subc-")  THEN REGEXP_EXTRACT(campaign_info,r"subc-([0-9]+)")
  ELSE "nosubcategory"
  END AS subcategory_id
 
  FROM subdivisions
  ),
cities_categories_subcategories AS
  (
  SELECT date, source, medium, campaign, cost, clicks, impressions, segment, channel, subdivision, city, country, category_name as category,
  sub_category_name as subcategory, is_retargeting_campaign
  FROM cities_categories_subcategories_id as a
  LEFT JOIN
  (SELECT city_id, city
  FROM `funnel-flowwow.MYSQL_EXPORT.f_city`
  GROUP BY city_id, city ) as b
  ON a.city_id=CAST(b.city_id AS STRING)
  LEFT JOIN
  (SELECT category_id, category_name
  FROM `funnel-flowwow.ANALYTICS_DM.category_subcategory`
  GROUP BY category_id, category_name) as c
  ON a.category_id=CAST(c.category_id AS STRING)
  LEFT JOIN
  (SELECT sub_category_id, sub_category_name
  FROM `funnel-flowwow.ANALYTICS_DM.category_subcategory`
  GROUP BY sub_category_id, sub_category_name) as d
  ON a.subcategory_id=CAST(d.sub_category_id AS STRING)
  LEFT JOIN
  (SELECT city_id, country_id
  FROM `funnel-flowwow.MYSQL_EXPORT.f_city_all`
  GROUP BY 1,2) as cities
  ON b.city_id=cities.city_id
  LEFT JOIN
  (SELECT country_id, country
  FROM `funnel-flowwow.MYSQL_EXPORT.f_country`
  GROUP BY 1,2) as countries
  ON cities.country_id=countries.country_id
  )




SELECT date, subdivision, channel, segment, source, medium, campaign,
is_retargeting_campaign,
CAST(IF(REGEXP_CONTAINS(LOWER(campaign),"wrld|world"),1,0) AS INT64) as is_world_campaign,
CAST(null AS STRING) as attributed_by,  CAST(null AS STRING) as city_from, city as city_to,
CAST(null AS STRING) as country_from, country as country_to,
category, subcategory, CAST(null AS STRING) as platform, SUM(cost) as ads_cost, 0 as service_cost, 0 as not_ads_cost,
SUM(clicks) as clicks, SUM(impressions) as impressions
FROM cities_categories_subcategories
GROUP BY date, subdivision, channel, segment, source, medium, campaign,
is_retargeting_campaign, is_world_campaign,
attributed_by, city_from, city_to, country_from, country_to, category, subcategory, platform
/*
-----------временные ручные косты по гуглу
UNION ALL
SELECT CAST(date AS DATE) as date, subdivision, channel, segment, "google" as source, "cpc" as medium, null as campaign,
null as is_retargeting_campaign, null as is_world_campaign, 
CAST(null AS STRING) as attributed_by,  CAST(null AS STRING) as city_from, CAST(null AS STRING) as city_to,
CAST(null AS STRING) as country_from, CAST(null AS STRING) as country_to,
CAST(null AS STRING) as category, CAST(null AS STRING) as subcategory, CAST(null AS STRING) as platform, CAST(ads_cost AS NUMERIC) as ads_cost, 0 as service_cost, 0 as not_ads_cost

FROM `funnel-flowwow.BUSINESS_DM.google_ads_cost_gs_view` 
WHERE ads_cost IS NOT NULL
---------------------
*/
UNION ALL
(SELECT date,
CASE
WHEN channel="seo" THEN "organic_web"
WHEN channel IN ("influencers","pr","serm","offline_merch","content_fw_client","creatives", "smm","instagram",
"mediaflights") THEN "brand"
WHEN channel IN ("cashback","geo_services","promocode_integration","donate") THEN "partners"
WHEN channel IN ("analytics") THEN "services"
WHEN channel IN ("appnext", "cpa","unity","vk_ads","unity_ios","unity_android","google_ads_uac","predownloads") THEN "paid_apps"
WHEN channel IN ("email_push") THEN "retention"
WHEN channel="aso_organic" THEN "organic_apps"
END AS subdivision,

CASE
WHEN REGEXP_CONTAINS(LOWER(segment),"unity") THEN "unity"
ELSE
LOWER(channel) END AS channel,


CASE
WHEN REGEXP_CONTAINS(LOWER(segment),"unity") THEN "unity"
WHEN channel="influencers" THEN "influencers"
WHEN channel="instagram" THEN "smm"
ELSE LOWER(segment)
END as segment,


CAST(null AS STRING) as source,
CAST(null AS STRING) as medium,
CAST(null AS STRING) as campaign,
CAST(0 AS INT64) as is_retargeting_campaign,
CAST(0 AS INT64) as is_world_campaign,
CAST(null AS STRING) as attributed_by,




CAST(null AS STRING) as city_from,
CAST(null AS STRING) as city_to,
CAST(null AS STRING) as country_from,
CAST(null AS STRING) as country_to,


CAST(null AS STRING) as category, CAST(null AS STRING) as subcategory, CAST(null AS STRING) as platform,


SUM(IF(channel NOT IN ("analytics","retention") AND segment NOT IN ("creatives","offline_merch","serm","all_cashback","all_promocode_integration","pr_rus","pr_international","donate","incentive_traffic"),cost,0)) as ads_cost,


SUM(IF(channel IN ("analytics","retention") OR segment="incentive_traffic",cost,0)) as service_cost,
SUM(IF(segment IN ("creatives","offline_merch","serm","all_cashback","all_promocode_integration","pr_rus","pr_international","donate"),cost,0)) as not_ads_cost,
0 as clicks,
0 as impressions
FROM `funnel-flowwow.BUSINESS_DM.cm_offline_costs_by_date`
WHERE cost IS NOT NULL AND segment NOT IN ("Criteo","vk_ads","google_ads_uac")
GROUP BY date, subdivision, channel, segment, source, medium, campaign, is_retargeting_campaign, is_world_campaign, attributed_by, city_from, city_to, country_from, country_to, category, subcategory, platform)